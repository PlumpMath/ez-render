/*! ez.render 19-01-2015 */
var EZ=EZ||{};EZ.ZERO=vec3.fromValues(0,0,0),EZ.LEFT=vec3.fromValues(1,0,0),EZ.UP=vec3.fromValues(0,1,0),EZ.FRONT=vec3.fromValues(0,0,1),EZ.WHITE=vec3.fromValues(1,1,1),EZ.BLACK=vec3.fromValues(0,0,0),EZ.temp_mat4=mat4.create(),EZ.temp_vec2=vec3.create(),EZ.temp_vec3=vec3.create(),EZ.temp_vec4=vec3.create(),EZ.temp_quat=quat.create(),EZ.entity_count=0,EZ.Entity=function(){this.uuid=EZ.entity_count++,this.name="",this.type="entity",this.position=vec3.create(),this.rotation=vec3.create(),this.quat=quat.create(),this.scale=vec3.create(),this.local_transform=mat4.create(),this.global_transform=mat4.create(),this.local_needs_update=!0,this.global_needs_update=!0,this.parent=null,this.children=[]},EZ.Entity.prototype={constructor:EZ.Entity,updateLocalMatrix:function(){mat4.identity(this.local_transform),mat4.translate(this.local_transform,this.local_transform,this.position),mat4.fromQuat(EZ.temp_mat4,this.quat),mat4.mul(this.local_transform,this.local_transform,EZ.temp_mat4),mat4.scale(this.local_transform,this.local_transform,this.scale),this.global_needs_update=!0},updateGlobalMatrix:function(a){this.local_needs_update&&this.updateLocalMatrix(),this.parent&&(a||this.parent.updateGlobalMatrix(),mat4.mul(this.global_transform,this.local_transform,this.parent.global_transform))},addChild:function(a){if(a.parent)throw"the child "+a.name+" has already a parent";a.parent=this,this.children.push(a),a.propagate("updateGlobalMatrix",[!0])},propagate:function(a,b){for(var c=0,d=this.children.length;d>c;c++){var e=this.children[c];e&&(e[a]&&e[a].apply(e,b),e.propagate(e,b))}},getAllChildren:function(){for(var a=[],b=0,c=this.children.length;c>b;b++){var d=this.children[b];a.push(d),d.getAllChildren(a)}return a}},EZ.EMesh=function(){EZ.Entity.call(this),this.color=vec4.fromValues(1,1,1,1),this.shader="",this.mesh="",this.mesh_obj=null,this.textures={},this.uniforms={u_color:this.color,u_color_texture:0},this.flags={},this.type="object3d"},EZ.EMesh.prototype=Object.create(EZ.Entity.prototype),EZ.EMesh.prototype.constructor=EZ.EMesh,EZ.EMesh.prototype.setTexture=function(a,b){b?"string"==typeof b&&(this.textures[a]=b):this.textures[a]=null},EZ.EMesh.prototype.render=function(a){if(this.mesh&&(this.mesh_obj=a.meshes[this.mesh]),this.mesh_obj){var b=0,c=null;for(var d in this.textures){var e=this.textures[d];c=a.textures[e],c||(c=a.textures.white),this.uniforms["u_"+d+"_texture"]=c.bind(b++)}var f=null;this.shader&&(f=a.shaders[shader_name]),f||(f=a.shaders.flat),a.frontFace(this.flags.flip_normals?a.CW:a.CCW),a[this.flags.depth_test===!1?"disable":"enable"](a.DEPTH_TEST),this.flags.depth_write===!1&&a.depthMask(!1),a[this.flags.two_sided===!0?"disable":"enable"](a.CULL_FACE),this.flags.blend&&(a.enable(a.BLEND),a.blendFunc(a.SRC_ALPHA,"additive"==node.blendMode?a.ONE:a.ONE_MINUS_SRC_ALPHA)),f.uniforms(this.uniforms),f.draw(this.mesh_obj,void 0===this.flags.primitive?a.TRIANGLES:node.primitive),this.flags.flip_normals&&a.frontFace(a.CCW),this.flags.depth_test===!1&&a.enable(a.DEPTH_TEST),this.flags.blend&&a.disable(a.BLEND),this.flags.two_sided&&a.disable(a.CULL_FACE),this.flags.depth_write===!1&&a.depthMask(!0)}},EZ.EScene=function(){EZ.Entity.call(this),this.type="scene"},EZ.EScene.prototype=Object.create(EZ.Entity.prototype),EZ.EScene.prototype.constructor=EZ.EScene,EZ.ECamera=function(a,b,c,d){EZ.Entity.call(this),this.aspect=b||1,this.fov=a||45,this.near=c||.1,this.far=d||1e3,this.type="camera",this.projection_matrix=mat4.create(),this.view_projection=mat4.create(),this.type="camera"},EZ.ECamera.prototype=Object.create(EZ.Entity.prototype),EZ.ECamera.prototype.constructor=EZ.ECamera,EZ.ECamera.prototype.updateProjectionMatrix=function(){mat4.perspective(this.projection_matrix,this.fov*DEG2RAD,this.aspect,this.near,this.far),mat4.mul(this.view_projection,this.global_transform,this.projection_matrix)},EZ.Renderer=function(){this.context=GL.create({width:1,height:1}),this.mvp_matrix=mat4.create(),this.uniforms={u_view:{},u_viewprojection:{},u_model:{},u_mvp:this.mvp_matrix}},EZ.Renderer.prototype={constructor:EZ.Renderer,addMesh:function(a,b){this.context.meshes[a]=b},loadAssets:function(){var a={lat:64,size:.5};a["long"]=64,this.addMesh("sphere",GL.Mesh.sphere(a)),this.addMesh("cylinder",GL.Mesh.cylinder({height:2,radius:.1})),this.addMesh("circle",GL.Mesh.circle({xz:!0})),this.addMesh("grid",GL.Mesh.grid({size:1,lines:50})),this.addMesh("box",GL.Mesh.box({size:1}))},setSize:function(a,b){this.context.canvas.width=a,this.context.canvas.height=b},setModelMatrix:function(a,b){mat4.multiply(this.mvp_matrix,b.view_projection,a)},setUniforms:function(a,b){this.uniforms={u_view:a.global_transform,u_viewprojection:a.view_projection,u_model:b.global_transform,u_mvp:this.mvp_matrix}},render:function(a,b){if(!a)throw"Renderer.render: scene not provided";if(!b)throw"Renderer.render: camera not provided";for(var c=a.getAllChildren(),d=null,e=0;e<c.length;++e)d=c[e],d.updateGlobalMatrix(!0);for(b.updateProjectionMatrix(),e=0;e<c.length;++e)d=c[e],this.setModelMatrix(d.global_transform,b),this.setUniforms(b,d),d.render&&d.render(this.context,b)}};